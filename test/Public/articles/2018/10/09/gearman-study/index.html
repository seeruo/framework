<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta author="">
	<meta description="">
	<meta keywords="">
	<title> PHP使用gearman进行任务分发 -  SeeRuo</title>
	<link rel="shortcut icon" href="/static/images/logo.ico" type="image/x-icon">
	<link rel="stylesheet" type="text/css" href="/static/css/style.css">
	<link rel="stylesheet" type="text/css" href="/static/prism/prism.css">
	<link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="/static/srsearch/srsearch.css">
    <script type="text/javascript" src="/static/srsearch/srsearch.js"></script>
</head>

<body>
	<main>
		<div class="sibar">
			<div class="author_header">
				<img src="/static/images/author.jpeg">
			</div>
			<div class="logo">
				<a href="/">SeeRuo</a>
				<small>< 轻量化静态网站构建工具 ></small>
			</div>
			<div class="menu">
				<a href="/">主页</a>
				<a href="/archives">归档</a>
				<a href="/about">关于</a>
				<a href="/linker">友链</a>
			</div>
			
			<div class="links">
				<a target="_blank" href="http://seeruo.codegrids.com">Sr</a>
				<a target="_blank" href="https://github.com/seeruo"><i class="fa fa-github"></i></a>
				<a target="_blank" href="mailto:cdking95@gmail.com"><i class="fa fa-envelope-o"> </i></a>
				<a><i class="fa fa-search" id="searchDiv"></i></a>
			</div>
		</div>
		<div class="content">
			<div class="markdown-body">
				<link rel="stylesheet" type="text/css" href="/static/srwords/srwords.css">
<script type="text/javascript" src="/static/srwords/srwords.js"></script>
<style type="text/css">
    #SeeruoWords{
        margin-top: 50px;
    }
</style>
<div class="content-block">
	<section>
				<h2>PHP使用gearman进行任务分发</h2>
		
		<p>Gearman是一个分发任务的程序框架，可以用在各种场合，与Hadoop相比，Gearman更偏向于任务分发功能。<br>它的任务分布非常简单，简单得可以只需要用脚本即可完成。<br>Gearman最初用于LiveJournal的图片resize功能，由于图片resize需要消耗大量计算资源，因此需要调度到后端多台服务器执行，完成任务之后返回前端再呈现到界面。</p><h3><a name='Gearman可以做什么' title='Gearman可以做什么'></a>Gearman可以做什么</h3><p>异步处理:图片处理,订单处理,批量邮件/通知之类的<br>要求高CPU或内存的处理:大容量的数据处理,MapReduce运算,日志聚集,视频编码<br>分布式和并行的处理<br>定时处理:增量更新,数据复制<br>限制速率的FIFO处理<br>分布式的系统监控任务</p><p>gearman中请求的处理过程一般涉及三种角色：client-&gt;job-&gt;worker</p><blockquote>client：是请求的发起者<br>job：是请求的调度者，用于把客户的请求分发到不同的worker上进行工作<br>worker：是请求的处理者</blockquote><p><a href="http://gearman.org/getting-started/">Gearman官方手册</a></p><h3><a name='安装' title='安装'></a>安装</h3><p><strong>首先安装gearman</strong></p><pre><code class="language-shell">[Du]# brew install gearman
==&gt; gearman
To have launchd start gearman now and restart at login:
  brew services start gearman
Or, if you don't want/need a background service you can just run:
  gearmand -d</code></pre><p><strong>安装php扩展</strong><br>前置需求<br>This extension requires the <strong>libgearman, libevent and uuid</strong> libraries, and a running Gearman server.</p><pre><code class="language-shell">[Du]# pecl install gearman</code></pre><h3><a name='Demo' title='Demo'></a>Demo</h3><p><strong>Client</strong></p><pre><code class="php">&lt;?php
//创建一个客户端
$client = new GearmanClient();
//添加一个job服务
$client-&gt;addServer('127.0.0.1', 4730);
//doBackground异步，返回提交任务的句柄
$ret = $client-&gt;doBackground('sendEmail', json_encode(array(
    'email' =&gt; 'test@qq.com',
    'title' =&gt; '测试异步',
    'body' =&gt; '异步执行好牛B的样子',
)));
 
//继续执行下面的代码
echo &quot;我的内心毫无波动，甚至还想笑\n&quot;;
 
do {
    sleep(1);
 
    //获取任务句柄的状态
    //jobStatus返回的是一个数组
    //第一个，表示工作是否已经知道
    //第二个，工作是否在运行
    //第三和第四，分别对应完成百分比的分子与分母
    $status = $client-&gt;jobStatus($ret);
     
    echo &quot;完成情况：{$status[2]}/{$status[3]}\n&quot;;
 
    if(!$status[1]) {
        break;
    }
} while(true);</code></pre><p><strong>Worker</strong></p><pre><code class="language-shell">&lt;?php
//创建一个worker
$worker = new GearmanWorker();
//添加一个job服务
$worker-&gt;addServer('127.0.0.1', 4730);
//注册一个回调函数，用于业务处理
$worker-&gt;addFunction('sendEmail', function($job) {
    //workload()获取客户端发送来的序列化数据
    $data = json_decode($job-&gt;workload(), true);
    //模拟发送邮件所用时间
    sleep(6);
    echo &quot;发送{$data['email']}邮件成功\n&quot;;
});
 
//死循环
//等待job提交的任务
while($worker-&gt;work());</code></pre><h3><a name='执行' title='执行'></a>执行</h3><p>我们先启动gearmand服务</p><pre><code class="language-shell">[Du]# gearmand</code></pre><p>在运行 worker</p><pre><code class="language-shell">[Du]# php worker.php</code></pre><p>最终运行client</p><pre><code class="language-shell">[Du]# php client.php</code></pre>

				<blockquote class="author_block">
			<ul>
				<li>本文作者: Danier(左浪)</li>
				<li>本文链接: http://www.example.com/articles/2018/10/09/gearman-study</li>
				<li>版权声明: 本博客所有文章除特别声明外，转载请注明出处！</li>
			</ul>
		</blockquote>
		<div id="SeeruoWords"></div>
		
	</section>
	<script type="text/javascript">
		document.querySelector('body').onload= function () {
			SrWords('#SeeruoWords',{
	            // apiBase:"http://api.codegrids.com/api"
	        })
		}
	</script>
</div>
			</div>
		</div>
	</main>
	<script src="/static/prism/prism.js"></script>
	<script type="text/javascript">
		SrSearch('#searchDiv',{
            // apiBase:"http://www.codegrids.com/articles"
        })
	</script>
</body>
</html>